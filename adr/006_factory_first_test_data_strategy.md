# ADR 006: Factory-First テストデータ戦略

## 概要
Laravel Featureテストにおけるテストデータ生成戦略を、従来のSeeder中心アプローチから**Factory-First**アプローチに変更する。

## 課題
現在のSeeder中心のテストデータ戦略（ADR002、ADR003）では以下の問題が発生している：

1. **隠れた依存関係**: テストが自身で作成していないデータに暗黙的に依存
2. **脆いテスト**: Seederへの変更が無関係なテストを破壊するリスク
3. **デバッグの困難**: テスト初期状態を理解するためにSeederを調査する必要
4. **実行速度の低下**: 大規模で複雑なデータセットの生成による非効率性
5. **保守性の悪化**: 複雑な階層構造とトレイトの管理負荷

## 決定事項
**Factory-First**パラダイムを採用し、以下のルールに従う：

### ルール1（デフォルト）: ファクトリを主役にする
- テストに必要な動的データは、テストの「Arrange」ブロック内でModelFactoryを使用して作成
- 全テストデータ作成の約95%をファクトリで処理

### ルール2（例外）: シーダーは限定的に使用
- 静的なマスターデータ（Role、Permission、システムカテゴリ等）のみシーダーを使用
- 必要に応じて`$this->seed()`でオンデマンド実行

### ルール3（禁止）: シーダーの乱用を防ぐ
- ランダムで動的なテストデータの生成にシーダーを使用しない
- グローバルな巨大シーダーによる全テストデータ生成を禁止

## ステータス
Accepted（ADR002、ADR003をSuperseded）

## 詳細

### 前提
- Laravel 12のModelFactory機能を活用
- RefreshDatabaseトレイトによるテスト分離
- AAAパターン（Arrange-Act-Assert）に従ったテスト構造

### 制約
- 既存のSeederファイルは段階的に移行
- 本番環境のマスターデータ投入は引き続きマイグレーション経由で実行

### 検討した選択肢

#### 1. Factory-Firstアプローチ（採用）
**利点:**
- テストの明示性と可読性が向上
- 各テストが自己完結し、依存関係が明確
- 保守性が高く、デバッグが容易
- 実行速度の向上

**実装例:**
```php
public function testCanCreateThread(): void
{
    // Arrange: ファクトリで必要なデータを明示的に作成
    $user = User::factory()->create();
    
    // Act
    $response = $this->actingAs($user)->post('/threads', [
        'title' => 'Test Thread'
    ]);
    
    // Assert
    $response->assertStatus(201);
}
```

#### 2. Seeder中心アプローチ（従来）
**問題点:**
- 隠れた依存関係による脆いテスト
- グローバル状態への依存
- デバッグの困難さ
- 保守性の低下

#### 3. 混合アプローチ（部分採用）
**採用理由:**
- 静的なマスターデータはシーダーが適切
- 動的なテストデータはファクトリが適切
- 用途に応じた使い分けが可能

### 判断基準

| データ種別 | 推奨ツール | 理由 |
|-----------|-----------|------|
| テスト用ユーザー | Factory | テスト固有の動的データ |
| 投稿・コメント | Factory | 文脈依存データ |
| 役割・権限 | Seeder | 静的マスターデータ |
| 国・地域リスト | Seeder | 参照データ |

### 移行計画
1. 新規テストはFactory-Firstで作成
2. 既存テストは段階的にリファクタリング
3. 不要なSeederファイルは削除
4. マスターデータSeederは`MasterDataSeeder`に統合

### 品質指標
- テストの自己完結性: 各テストが独立して実行可能
- 実行速度: テストスイートの実行時間短縮
- 保守性: テスト失敗の原因特定が容易
- 可読性: テストの意図が明確